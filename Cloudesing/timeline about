"use client";

import Image from "next/image";
import { useEffect, useRef, useState } from "react";

export default function JourneyTimeline() {
  const scrollContainerRef = useRef<HTMLDivElement | null>(null);
  const autoScrollRef = useRef<number | null>(null);
  const userScrollTimeoutRef = useRef<NodeJS.Timeout | null>(null);

  const [isUserScrolling, setIsUserScrolling] = useState(false);
  const [activeIndex, setActiveIndex] = useState<number | null>(null);

  const singleTimelineWidth = 3600;

  const timelineEvents = [
    {
      year: "2015",
      position: "bottom", // Card at bottom, Year at top
      icon: "/image/About/badge.webp",
      description:
        "Birth of Cloudtrack, A world-class logistics software, that fueled partnerships with industry leaders like",
      logos: [
        { name: "Stellar", path: "/image/About/stellar.webp", height: 46 },
        {
          name: "Hexagonal",
          path: "/image/About/cloudtrack_logo.webp",
          height: 50,
        },
      ],
    },
    {
      year: "2016",
      position: "top", // Card at top, Year at bottom
      icon: "/image/About/badge.webp",
      description:
        "Exemplary service quality fuels market demand and creates collaborations with ground-breaking startups like",
      logos: [
        { name: "DOORMINT", path: "/image/About/doormint.webp", height: 38 },
        { name: "KODO", path: "/image/About/kodo.webp", height: 26 },
        { name: "grayQuest", path: "/image/About/grayquest.webp", height: 28 },
        { name: "zoctor", path: "/image/About/zoctor.webp", height: 26 },
      ],
    },
    {
      year: "2017",
      position: "bottom",
      icon: "/image/About/grothicon.webp",
      description: "The First Milestone ",
      highlight: "1 Million USD in Revenue",
      subText: "is reached with an in-house team of 50-plus engineers",
    },
    {
      year: "2020",
      position: "top",
      icon: "/image/About/badge.webp",
      description: "Cloudesign becomes a recognized technology partner of",
      logos: [
        { name: "AWS", path: "/image/logo/aws.webp", height: 38 },
        { name: "UiPath", path: "/image/logo/uipath.webp", height: 46 },
        { name: "Microsoft", path: "/image/logo/microsoft.webp", height: 38 },
      ],
    },
    {
      year: "2021",
      position: "bottom",
      icon: "/image/About/checkicon.webp",
      description:
        "Cloudtrack becomes on independent entity led by Nishant Shetty and Shivalik Prasad(Executive Director, Map My India)",
      logos: [
        { name: "Baxter", path: "/image/logo/baxter.webp", height: 24 },
        { name: "Daikin", path: "/image/logo/daikin.webp", height: 46 },
        { name: "Kurion", path: "/image/logo/kurion.webp", height: 24 },
        {
          name: "Johnson & Johnson",
          path: "/image/logo/johnsons.webp",
          height: 38,
        },
      ],
    },
    {
      year: "2023",
      position: "top",
      icon: "/image/About/grothicon.webp",
      description: "Cloudesign Touches ",
      highlight: "5 Million USD in Revenue",
      subText: "is reached with an in-house",
    },
  ];

  /* -------------------------------
     Infinite Scroll Boundary Logic
  -------------------------------- */
  useEffect(() => {
    const container = scrollContainerRef.current;
    if (!container) return;

    container.scrollLeft = singleTimelineWidth;

    const onScroll = () => {
      const max = singleTimelineWidth * 2;

      if (container.scrollLeft >= max - 50) {
        container.scrollLeft -= singleTimelineWidth;
      }

      if (container.scrollLeft <= 50) {
        container.scrollLeft += singleTimelineWidth;
      }
    };

    container.addEventListener("scroll", onScroll);
    return () => container.removeEventListener("scroll", onScroll);
  }, []);

  /* -------------------------------
     Auto Scroll
  -------------------------------- */
  useEffect(() => {
    const container = scrollContainerRef.current;
    if (!container) return;

    const speed = 0.5;

    const loop = () => {
      if (!isUserScrolling) {
        container.scrollLeft += speed;
      }
      autoScrollRef.current = requestAnimationFrame(loop);
    };

    autoScrollRef.current = requestAnimationFrame(loop);

    return () => {
      if (autoScrollRef.current) {
        cancelAnimationFrame(autoScrollRef.current);
      }
    };
  }, [isUserScrolling]);

  /* -------------------------------
     Manual Scroll Detection
  -------------------------------- */
  useEffect(() => {
    const container = scrollContainerRef.current;
    if (!container) return;

    const handleInteraction = () => {
      setIsUserScrolling(true);
      if (userScrollTimeoutRef.current) {
        clearTimeout(userScrollTimeoutRef.current);
      }

      userScrollTimeoutRef.current = setTimeout(() => {
        setIsUserScrolling(false);
      }, 2000);
    };

    container.addEventListener("wheel", handleInteraction, { passive: true });
    container.addEventListener("mousedown", handleInteraction);
    container.addEventListener("touchstart", handleInteraction);

    return () => {
      container.removeEventListener("wheel", handleInteraction);
      container.removeEventListener("mousedown", handleInteraction);
      container.removeEventListener("touchstart", handleInteraction);
    };
  }, []);

  /* -------------------------------
     Viewport-Based Activation Logic
     (LEFT HALF OF SCREEN)
  -------------------------------- */
  useEffect(() => {
    const container = scrollContainerRef.current;
    if (!container) return;

    const updateActiveCard = () => {
      const cards =
        container.querySelectorAll<HTMLElement>("[data-card-index]");
      const triggerX = window.innerWidth * 0.5;

      cards.forEach((card) => {
        const rect = card.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const index = Number(card.dataset.cardIndex);

        if (centerX <= triggerX && centerX >= 0) {
          setActiveIndex(index);
        }
      });
    };

    const raf = () => {
      updateActiveCard();
      requestAnimationFrame(raf);
    };

    requestAnimationFrame(raf);
  }, []);

  /* -------------------------------
     Render
  -------------------------------- */
  return (
    <section className="bg-[#0A0A0A] py-[80px] overflow-hidden font-sans">
      <div className="relative h-[600px] overflow-hidden">
        <div
          ref={scrollContainerRef}
          className="overflow-x-auto scrollbar-hide h-full cursor-grab active:cursor-grabbing"
          style={{ scrollBehavior: isUserScrolling ? "auto" : "smooth" }}
        >
          <div className="relative inline-flex items-center h-full">
            {[1, 2].map((copy) => (
              <div
                key={copy}
                className="relative inline-flex items-center h-full flex-shrink-0"
                style={{ minWidth: "3600px" }}
              >
                <div className="absolute w-full h-[1px] bg-white/10 top-1/2 -translate-y-1/2" />

                <div className="relative flex justify-between w-full px-8 z-10">
                  {timelineEvents.map((event, index) => {
                    const globalIndex = index;
                    const isActive = activeIndex === globalIndex;

                    return (
                      <div
                        key={`${copy}-${index}`}
                        data-card-index={globalIndex}
                        className="relative flex flex-col items-start flex-1"
                      >
                        {/* Node */}
                        <div className="relative">
                          <div
                            className={`absolute top-1/2 left-[36px] -translate-x-1/2 -translate-y-1/2 w-8 h-8 rounded-full blur-md transition-all duration-200 ${
                              isActive
                                ? "bg-red-600/80 scale-110"
                                : "bg-red-600/40"
                            }`}
                          />
                          <div
                            className={`w-3 h-3 rounded-full border-2 ml-8 relative z-10 transition-all duration-200 ${
                              isActive
                                ? "bg-red-600 border-red-600 scale-125"
                                : "bg-[#0A0A0A] border-white/20"
                            }`}
                          />
                        </div>

                        {/* Card */}
                        <div
                          className={`absolute ${
                            event.position === "top"
                              ? "bottom-[40px]"
                              : "top-[40px]"
                          } left-8 w-[530px] bg-gradient-to-b from-[rgba(35,35,35,0)] to-[#232323] rounded-xl p-4 border shadow-2xl transition-all duration-200 ${
                            isActive ? "border-red-600/50" : "border-[#353535]"
                          }`}
                        >
                          <p className="text-gray-400 text-lg leading-relaxed">
                            {event.description}
                          </p>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </section>
  );
}
